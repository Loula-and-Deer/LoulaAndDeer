<script>
  (function($) {
    $(function() {
      var understoodPersonalisedChanges = false;
      //Fixes ugly PayPal checkout button
      $("#paypal-express-button").removeClass("additional-checkout-button");
      $("#paypal-express-button").removeClass("additional-checkout-button--paypal-express");
      $("#paypal-express-button").addClass("extra-checkout-button")

      //Removes "Checkout with PayPal" text from PayPal button
      $('#paypal-express-button').contents().filter(function() {
        return this.nodeType === 3;
      }).remove();

      //Item information handler
      $(".fa-ellipsis-v").on("click", function() {
        var item = $(this).parent().parent();
        var info = $(this).parent().parent().find(".cart-item-addtional-info");
        if (item.attr("expanded") == "false") {
          item.attr("expanded", "true");
          item.addClass("shadow");
          info.css("display", "block");
          item.height(100 + info.height());
        } else {
          item.attr("expanded", "false");
          item.removeClass("shadow");
          item.height(100);
          info.css("display", "none");
        }
      });


    $('.cart__quantity_dec').on("click", function() {
      var val = $(this).next().val();
      if (val > 1){
      val--;
      $(this).next().val(val);
      $(this).next().trigger("change");
      }
    });

    $('.cart__quantity_inc').on("click", function() {
      var val = $(this).prev().val();
  
      val++;
      $(this).prev().val(val);
      $(this).prev().trigger("change");
      
    });
      //On item quantity change
      $('.cart__quantity').on("change", function() {
        var quanDOM = $(this);
        //Disables quantity input.
        quanDOM.attr("disabled", "disabled");
        var line = $(this).attr("data-line");
        var quan = $(this).val();
        var lineprice = '#lineprice_' + line;
        var linetitle = '#linetitle_' + line;

      if ($(linetitle).html().toLowerCase().indexOf("personalised") >= 0 && !understoodPersonalisedChanges) {
        var answer = confirm("Warning. Changing the quantity of a personalised item may have an unwanted result. Change anyway?")
        if (!answer) {
          quanDOM.removeAttr("disabled");
          return null;
        } 
      }
      understoodPersonalisedChanges = true;
      /**
       * POSTS quantity change
       * @param {String} URL to POST to
       * @param {Object} Data to POST
       * @param {Fucntion} Function on success
       * @return {JSON} The JSON of the cart.
       */
        $.post('/cart/change.js', {
            line: line,
            quantity: quan
          }, function(cart) {
            //Item offset of -1
            //Line item index is cart item index - 1
            var item = cart.items[line - 1];

            //Update totals.
            $('.subtotal').html(Shopify.formatMoney(cart.total_price, "{{ shop.money_with_currency_format}}"));
            $('.subtotal-preview').html("SUBTOTAL &nbsp; &nbsp; &nbsp;" + Shopify.formatMoney(cart.total_price, "{{ shop.money_with_currency_format  }}"));

            //Update item price with (price * quantity).
            $(lineprice).html(Shopify.formatMoney(item.line_price, "{{ shop.money_with_currency_format }}"));

            //Update item title.
            if (item.quantity > 1) {
              $(linetitle).html(item.product_title + " | x" + item.quantity);
            } else {
              $(linetitle).html(item.product_title);
            }
            //Enables quantity input to be changed.
            quanDOM.removeAttr("disabled");

          }, "json")
          .fail(function(xhr, status, error) {
            //POST failed.
            if(status == 422){

            } else {
            alert("Something wen't wrong. Sorry.");
          }
          });
      });
    });
  })(jQuery); 
</script>